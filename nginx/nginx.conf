worker_processes auto;
events { worker_connections 1024; }

http {
  # Backends en la red de Docker
  upstream frontend { server frontend:3000; }
  upstream backend  { server backend:4000; }

  # NGINX solo escucha en 80 (el ALB ya hace HTTPS hacia fuera)
  server {
    listen 80 default_server;
    server_name _;

    # Healthcheck del ALB (debe responder 200 SIN redirigir)
    location = /_elb_health { return 200; }

    # -------- Frontend (Next con basePath /login_cert) --------
    location /login_cert/ {
      proxy_pass http://frontend;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;   # el cliente venía por https al ALB
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_buffering off;
    }

    # -------- API (dos rutas por si el front llama con/ sin basePath) --------
    # /api/* → backend
    location /api/ {
      proxy_pass http://backend;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # /login_cert/api/* → backend (cuando el front resuelve relativo con basePath)
    location /login_cert/api/ {
      proxy_pass http://backend/api/;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # -------- Handshake (sin mTLS aquí porque el ALB termina TLS) --------
    location = /api/handshake {
      proxy_pass http://backend/api/handshake;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    location = /login_cert/api/handshake {
      proxy_pass http://backend/api/handshake;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
    }

    # Raíz → /login_cert
    location = / { return 301 /login_cert/; }
  }
}
